<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>School Choice Algorithms</title>
<!-- 2015-11-01 Sun 19:22 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Christoph SchottmÃ¼ller" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js"></script>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">School Choice Algorithms</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Reading in preferences and priorities</h2>
<div class="outline-text-2" id="text-1">
<p>
A school choice problem consists of the following ingredients: A number of schools and a number of students, for each student a preference ordering over schools, for each school a capacity and a priority ordering over students. If we have \(n\) students, we will call these students 0,1,&#x2026;,n-1. Similarly, we call the \(m\) schools 0, 1,&#x2026;,m-1. We assume that there are two text files which contain all the data:
</p>

<ul class="org-ul">
<li>the first file has in each line the capacity and priority ordering of one school. A priority ordering is a comma separated list of integers where the first integer is the student number of the student with the highest priority. The first line contains as first entry the capacity and then the priority ordering of school 0, the second of school 1 etc.
</li>
<li>the second file has in each line the preference ordering of one student. A preference ordering is a comma separated list of integers where the first integer is the school number of the most preferred school etc. The first line contains the preferences of student 0 etc.
</li>
</ul>

<p>
The function \(read\_sc\) takes the file names of these two files and transforms the data in a usable format. What we want to have is 
</p>
<ul class="org-ul">
<li>a list <i>capacity</i> that contains as <i>k</i>-th element the capacity of school <i>k</i>,
</li>
<li>a list <i>priority</i> that consists of <i>m</i> lists where the <i>k</i>-th list contains the priority ordering of school <i>k</i> (as usual in python we start counting at 0),
</li>
<li>a list <i>preference</i> that contains <i>n</i> lists where the <i>k</i>-th list contains the preference of student <i>k</i>.
</li>
</ul>

<p>
The following code reads the file containing information on the schools line by line. It deletes the linebreak character '\n', splits the line into a list using ',' as separator, extracts the information necessary, changes the type of the information from string to integer and appends the first number to the capacity list and the rest to the priority list. The same is then done for the student file and the preference list. Finally, all three lists are returned.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">read_sc</span>(school,student):
    <span style="color: #2aa198;">"""reads in data from two files: 'school' contains in line k first the capacity of school k and then the student numbers separated by ',' ordered according to k's priorities from highest to lowest priority; 'student' has in line k the preferences of student k i.e. a sequence of school numbers from best to worst separated by ',' """</span>
    <span style="color: #268bd2;">school_file</span> = <span style="color: #859900;">open</span>(school,<span style="color: #2aa198;">'r'</span>)
    <span style="color: #268bd2;">capacity</span> = []
    <span style="color: #268bd2;">priority</span> = []
    <span style="color: #859900;">for</span> line <span style="color: #859900;">in</span> school_file:
        line.strip()
        <span style="color: #268bd2;">line</span> = line.split(<span style="color: #2aa198;">','</span>)
        <span style="color: #268bd2;">num_line</span> = []
        <span style="color: #859900;">for</span> element <span style="color: #859900;">in</span> line:
            num_line.append(<span style="color: #859900;">int</span>(element))
        capacity.append(num_line.pop(0))
        priority.append(num_line)
    school_file.close()
    <span style="color: #268bd2;">stud_file</span> = <span style="color: #859900;">open</span>(student,<span style="color: #2aa198;">'r'</span>)
    <span style="color: #268bd2;">preference</span> = []
    <span style="color: #859900;">for</span> line <span style="color: #859900;">in</span> stud_file:
        line.strip()
        <span style="color: #268bd2;">line</span> = line.split(<span style="color: #2aa198;">','</span>)
        <span style="color: #268bd2;">num_line</span>=[]
        <span style="color: #859900;">for</span> element <span style="color: #859900;">in</span> line:
            num_line.append(<span style="color: #859900;">int</span>(element))
        preference.append(num_line)
    stud_file.close()
    <span style="color: #859900;">return</span> priority, capacity, preference
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Generating a school choice problem (randomly)</h2>
<div class="outline-text-2" id="text-2">
<p>
In order to test the code later on (in case we do not have real data to use), we want to have the possibility to generate example school choice problems. The function below randomly generates such problems. It takes as arguments the number of schools and students. Optional arguments can be used to indicate that only problems where 
</p>
<ul class="org-ul">
<li>there is more capacity than students
</li>
<li>the overcapacity is limited by the given argument
</li>
</ul>
<p>
are generated. The last optional argument indicates whether the problem should be saved in files (in the format that can be read by \(read\_sc\); see above). As the function is a bit longer, we split it up in several parts. 
</p>

<p>
First, the capacity list is created. For each school, a capacity is randomly drawn from a triangular distribution with mode at 0.2*nstud/nschool (and support from nstud/(10*nschool) to 3*nstud/nschool). If the overcapacity option is given, it is checked that indeed there is overcapacity; otherwise the procedure is repeated. Similarly, with the maxovercapacity option.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">gen_sc</span>(nschool,nstud,overcap=<span style="color: #2aa198;">False</span>,maxovercap=<span style="color: #2aa198;">False</span>,savefile=<span style="color: #2aa198;">False</span>):
    <span style="color: #2aa198;">"""generates a (pseudo) random school choice problem with nstud students and nschool schools; if overcap ==True, the problem will have a higher number school places than students; maxovercap is a maximum overcapacity allowed; savefile=True will OVERWRITE/save the generated example in the files school.txt and student.txt in the current working directory"""</span>
    <span style="color: #268bd2;">capacity</span> = []
    <span style="color: #268bd2;">average</span> = <span style="color: #859900;">float</span>(nstud)/nschool
    <span style="color: #268bd2;">i</span> = 1
    <span style="color: #859900;">while</span> i&lt;= nschool:
        capacity.append(<span style="color: #859900;">int</span>(random.triangular(average/10.0,3*average,0.2*average)))<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">draws capacity from a triangular distribution between average/5 and 5*average with mode at 0.9*average</span>
        <span style="color: #268bd2;">i</span> = i + 1
        <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">print capacity, i, nschool, sum(capacity)</span>
        <span style="color: #859900;">if</span> i == nschool <span style="color: #859900;">and</span> overcap==<span style="color: #2aa198;">True</span> <span style="color: #859900;">and</span> <span style="color: #859900;">sum</span>(capacity)&lt;nstud:<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">checks that enough places for all students are available</span>
            <span style="color: #268bd2;">capacity</span> = []
            <span style="color: #268bd2;">i</span> = 1
        <span style="color: #859900;">if</span> maxovercap!=<span style="color: #2aa198;">False</span> <span style="color: #859900;">and</span> <span style="color: #859900;">sum</span>(capacity)&gt;nstud + maxovercap:
            <span style="color: #268bd2;">capacity</span> = []
            <span style="color: #268bd2;">i</span> = 1
</pre>
</div>
<p>
The next part creates priority and preferences randomly. First a list [1,2,&#x2026;,nstud] is created and then the order of this list is randomly shuffled.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #268bd2;">priority</span> = []
<span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nschool):
    <span style="color: #268bd2;">x</span> = <span style="color: #859900;">range</span>(nstud)
    random.shuffle(x)
    priority.append(x)
<span style="color: #268bd2;">preference</span> = []
<span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nstud):
    <span style="color: #268bd2;">x</span> = <span style="color: #859900;">range</span>(nschool)
    random.shuffle(x)
    preference.append(x)
</pre>
</div>
<p>
If the overcapacity option is False, then it can be the case that there are more students than capacity and some students remain unmatched. To accommodate this option, a dummy school is created: This school has ample capacity and is least liked by all students. All the students that cannot be matched with any proper school will be assigned to this dummy school by the matching algorithms used below. This  trick avoids some technical problems that would otherwise occur (e.g. having unmatched students after every step of the algorithm). Note that the number of schools including the dummy school is nschool+1. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">if</span> <span style="color: #859900;">sum</span>(capacity)&lt;nstud:<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">creates a dummy school "nschool+1" to which every student not getting a place will be matched</span>
    <span style="color: #859900;">for</span> student <span style="color: #859900;">in</span> preference:
        student.append(nschool)
    priority.append(<span style="color: #859900;">range</span>(nstud))
    capacity.append(nstud)
</pre>
</div>
<p>
Finally, we save the generated data in files 'school.txt' and 'student.txt' if the relevant option is not False. These files are generated line by line where first the data is changed into string format, striped of the brackets indicating the begin and end of a list and equipped with a line break. Finally, the generated data is returned.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">if</span> savefile!=<span style="color: #2aa198;">False</span>:
    <span style="color: #268bd2;">school_file</span> = <span style="color: #859900;">open</span>(<span style="color: #2aa198;">'school.txt'</span>,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nschool):
        <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(capacity[i]) + <span style="color: #2aa198;">','</span>
        <span style="color: #268bd2;">priority_str</span> = <span style="color: #859900;">str</span>(priority[i])
        <span style="color: #268bd2;">priority_str</span> = priority_str.strip(<span style="color: #2aa198;">'['</span>)
        <span style="color: #268bd2;">priority_str</span> = priority_str.strip(<span style="color: #2aa198;">']'</span>)
        <span style="color: #268bd2;">line</span> = line + priority_str 
        school_file.write(line)
        school_file.write(<span style="color: #2aa198;">"\n"</span>)
    school_file.close()
    <span style="color: #268bd2;">stud_file</span> = <span style="color: #859900;">open</span>(<span style="color: #2aa198;">'student.txt'</span>,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nstud):
        <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(preference[i])
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">'['</span>)
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">']'</span>)
        stud_file.write(line)
        stud_file.write(<span style="color: #2aa198;">"\n"</span>)
    stud_file.close()
<span style="color: #859900;">return</span> priority, capacity, preference
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> The schoolchoice class</h2>
<div class="outline-text-2" id="text-3">
<p>
We now generate a class 'schoolchoice'. An instance of this class is a specific school choice problem, i.e. we have given capacity, priority and preference lists. The class will contain functions that we can use on this specific problems, e.g. matching algorithms. As the code is a bit longer, we split it up in different parts.
</p>

<p>
When we create an instance of the class we have to give the priority, capacity and preference list as arguments. These become variables of this instance. The number of students and schools is readily derived from these lists and saved. We also create variables that are empty for now but will save the calculated matchings as soon as we have calculated them.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">class</span> <span style="color: #b58900;">schoolchoice</span>:
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">__init__</span>(<span style="color: #859900;">self</span>,priority, capacity, preference):
        <span style="color: #2aa198;">"""read in data: priorities is a list of lists where the kth lower level list is the priority of school k, capacity is a list of school capacities (same order of schools as in priority), preferences is a list of lists where the ith sublist is the preference ranking of student i"""</span>
        <span style="color: #859900;">self</span>.priority = priority
        <span style="color: #859900;">self</span>.capacity = capacity
        <span style="color: #859900;">self</span>.preference = preference
        <span style="color: #859900;">self</span>.nschool = <span style="color: #859900;">len</span>(capacity)
        <span style="color: #859900;">if</span> <span style="color: #859900;">self</span>.nschool != <span style="color: #859900;">len</span>(priority):
            <span style="color: #859900;">print</span> <span style="color: #2aa198;">"input error: capacity and priority list must have same length"</span>
        <span style="color: #859900;">self</span>.nstud = <span style="color: #859900;">len</span>(preference)
        <span style="color: #859900;">self</span>.gs_match = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">will contain Gale Shapley match if this is calculated</span>
        <span style="color: #859900;">self</span>.boston_match = []
</pre>
</div>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Gale Shapley algorithm</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The Gale Shapley<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup> algorithm creates a matching that has the following advantages
</p>
<ul class="org-ul">
<li>strategy proofness for students: no student can improve his outcome by submitting a wrong preference profile.
</li>
<li>stability: There is no student-school pair such that the student prefers this school over his assigned school and at the same time he has higher priority at this school than some student assigned to it.
</li>
<li>student optimality among stable matchings: there is no other stable matching in which some student(s) would be assigned a more preferred school than the one he is assigned in the Gale-Shapley algorithm.
</li>
<li>finiteness: the algorithm converges in a finite number of steps.
</li>
</ul>

<p>
The algorithm can be illustrated nicely with the following thought experiment: There are a number of rounds. In each round, every unmatched student applies at his most preferred school among the schools he did not apply in earlier rounds. Schools accept in each round the most preferred students among those students that apply and those students that were matched with the school in the previous round. Of course, each school can in each round not be matched with more students than its capacity. The algorithm stops when all students are matched at the end of a round.
</p>

<p>
Each round is given by one iteration of the "while flag==0" loop. In each round, we loop over all schools ('for i in range(self.school):'):
</p>
<ol class="org-ol">
<li>first we determine the list of students that have this school as their highest priority and order them according to the school's priority ('proposers').
</li>
<li>we match either all proposers (less proposers than capacity) or as many as possible with the school. In the latter case, the unmatched students are put in the list 'unmatched'.
</li>
</ol>
<p>
At the end of the round, we check whether there are unmatched students. If not, the algorithm stops. If there are unmatched students, we delete the first preference in their preference ordering (this is the schooled to which they applied in this round and could not get in). This little trick is notationally convenient as it allows us to say that everyone applies to his most preferred school in the remaining preference ordering in each round (see step 1 above).
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">gs</span>(<span style="color: #859900;">self</span>):
    <span style="color: #2aa198;">"""uses the Gale Shapley student proposing algorithm to solve the matching problem"""</span>
    <span style="color: #268bd2;">flag</span> = 0 <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">dummy used to indicate whether the algorithm has finished</span>
    <span style="color: #268bd2;">pref</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.preference) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
    <span style="color: #859900;">while</span> flag == 0:
        <span style="color: #268bd2;">flag</span> = 1
        <span style="color: #268bd2;">match</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">contains list of lists where the kth lower level list are the students matched with school k</span>
        <span style="color: #268bd2;">unmatched</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of unmatched students</span>
        <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool):
            <span style="color: #268bd2;">proposers</span> = <span style="color: #859900;">filter</span>(<span style="color: #859900;">lambda</span> x: i==pref[x][0],<span style="color: #859900;">self</span>.priority[i])<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">list of students proposing to i in this round</span>
            <span style="color: #859900;">if</span> <span style="color: #859900;">len</span>(proposers)&lt;=<span style="color: #859900;">self</span>.capacity[i]:
                match.append(proposers)
            <span style="color: #859900;">else</span>:
                match.append(proposers[:<span style="color: #859900;">self</span>.capacity[i]])
                <span style="color: #268bd2;">unmatched</span> = unmatched +proposers[<span style="color: #859900;">self</span>.capacity[i]:]
        <span style="color: #859900;">if</span> unmatched != []:
            <span style="color: #268bd2;">flag</span> = 0
            <span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> unmatched:
                <span style="color: #268bd2;">pref</span>[j]=pref[j][1:] <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">deletes the top preference for the unmatched</span>
    <span style="color: #859900;">self</span>.gs_match = <span style="color: #859900;">list</span>(match)
    <span style="color: #859900;">return</span> match
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Boston student matching algorithm</h3>
<div class="outline-text-3" id="text-3-2">
<p>
This algorithm was used in Boston (and other cities) for some time. It has the advantage that the matching is Pareto efficient if all students submit their true preferences. Unfortunately, it is not strategy proof which means that for some preference profiles some students could benefit from submitting a wrong preference ('game the system').
</p>

<p>
The algorithm works in rounds. In round 1, we try to put all students to the school that is their most preferred school. If the number of students having school <i>k</i> as most preferred is higher than the capacity of school <i>k</i>, we use the priority ordering of <i>k</i> to determine who gets the place. In round 2, we try to allocate all the students that did not get a place in the first round to their second most preferred school. If the remaining capacity of a school ('remaining' because some students got a place there in the first round), we use the priority order to determine who gets the place. We continue like this until all students have a place.
</p>

<p>
Each round is given by one iteration of the 'while flag==0' loop. As in the Gale Shapley algorithm, we the loop over schools ('for i in range(self.nschool)'). The list of 'proposers' (unmatched students who have this school as their top remaining choice) is ordered according to the school's priority ranking and as many as possible are allocated to the remaining capacity (we then reduce the remaining capacity accordingly). The one's that could not be matched are put on the unmatched list, the one's matched to school \(i\) are put on the match[i] list. The algorithm stops if no student is unmatched at the end of a round. At the end of a round, the top preference of the unmatched is deleted from their preferences. This allows us to write out code as if everyone only considers his top preference in each round.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">boston</span>(<span style="color: #859900;">self</span>):
    <span style="color: #2aa198;">"""uses the Boston school matching algorithm to solve the matching problem"""</span>
    <span style="color: #268bd2;">flag</span> = 0 <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">dummy used to indicate whether the algorithm has finished</span>
    <span style="color: #268bd2;">pref</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.preference) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
    <span style="color: #268bd2;">capa</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.capacity) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
    <span style="color: #268bd2;">match</span> = [[] <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool)] <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of nschool empty lists, kth list is list of students at school k</span>
    <span style="color: #859900;">while</span> flag == 0:
        <span style="color: #268bd2;">flag</span> = 1
        <span style="color: #268bd2;">unmatched</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of unmatched students</span>
        <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool):
            <span style="color: #268bd2;">proposers</span> = <span style="color: #859900;">filter</span>(<span style="color: #859900;">lambda</span> x: i==pref[x][0] <span style="color: #859900;">and</span> x <span style="color: #859900;">not</span> <span style="color: #859900;">in</span> match[i],<span style="color: #859900;">self</span>.priority[i])<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">list of students proposing to i in this round</span>
            <span style="color: #859900;">if</span> <span style="color: #859900;">len</span>(proposers)&lt;=capa[i]:
                <span style="color: #268bd2;">match</span>[i] = match[i] + proposers
                <span style="color: #268bd2;">capa</span>[i] = capa[i] - <span style="color: #859900;">len</span>(proposers)
            <span style="color: #859900;">else</span>:
                <span style="color: #268bd2;">match</span>[i] = match[i] + proposers[:capa[i]]
                <span style="color: #268bd2;">unmatched</span> = unmatched + proposers[capa[i]:]
                <span style="color: #268bd2;">capa</span>[i] = 0
        <span style="color: #859900;">if</span> unmatched != []:
            <span style="color: #268bd2;">flag</span> = 0
            <span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> unmatched:
                pref[j].pop(0) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">deletes the top preference for the unmatched</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Saving calculated matchings</h2>
<div class="outline-text-2" id="text-4">
<p>
There are two convenient ways to represent a matching: first, a list that gives for each student the school he is assigned. Second, a list that gives for each school the students it is assigned.
</p>

<p>
The function below creates both files for a given match (file names are optional). Matchings are represented as a list of lists where the <i>k</i>-th lower level list contains the students assigned to school <i>k</i>. Hence, going through the matching one lower level list at a time only requires a bit of formatting to get the matching in the second representation. To get the firs representation, we create for every student the (student,school) tuple and sort those tuples according to student numbers before doing some basic formatting and saving.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">def</span> <span style="color: #268bd2;">save_match</span>(match,filename_school=<span style="color: #2aa198;">'match_school.txt'</span>,filename_student=<span style="color: #2aa198;">'match_student.txt'</span>):
    <span style="color: #2aa198;">"""saves a given match in 2 files: 'match_school' contains in line k the student numbers matched to school k; 'match_student' contains in line k the school matched to student k"""</span>
    <span style="color: #268bd2;">student_lst1</span> = []
    <span style="color: #268bd2;">school_lst</span> = <span style="color: #859900;">open</span>(filename_school,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> school <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">len</span>(match)):
        <span style="color: #859900;">for</span> student <span style="color: #859900;">in</span> match[school]:
            student_lst1.append((student,school))
        <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(match[school].sort())
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">'['</span>)
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">']'</span>)
        school_lst.write(line)
        school_lst.write(<span style="color: #2aa198;">'\n'</span>)
    <span style="color: #268bd2;">student_lst1</span> = <span style="color: #859900;">sorted</span>(student_lst1)
    <span style="color: #268bd2;">student_lst</span> = <span style="color: #859900;">open</span>(filename_student,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> item <span style="color: #859900;">in</span> student_lst1:
        student_lst.write(<span style="color: #859900;">str</span>(item[1]))
        student_lst.write(<span style="color: #2aa198;">'\n'</span>)
    student_lst.close()
    school_lst.close()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> All code together in one program and examples of usage</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-python" id="scp"><span style="color: #859900;">import</span> random
<span style="color: #859900;">import</span> cPickle <span style="color: #859900;">as</span> pickle

<span style="color: #859900;">def</span> <span style="color: #268bd2;">read_sc</span>(school,student):
    <span style="color: #2aa198;">"""reads in data from two files: 'school' contains in line k first the capacity of school k and then the student numbers separated by ',' ordered according to k's priorities from highest to lowest priority; 'student' has in line k the preferences of student k i.e. a sequence of school numbers from best to worst separated by ',' """</span>
    <span style="color: #268bd2;">school_file</span> = <span style="color: #859900;">open</span>(school,<span style="color: #2aa198;">'r'</span>)
    <span style="color: #268bd2;">capacity</span> = []
    <span style="color: #268bd2;">priority</span> = []
    <span style="color: #859900;">for</span> line <span style="color: #859900;">in</span> school_file:
        line.strip()
        <span style="color: #268bd2;">line</span> = line.split(<span style="color: #2aa198;">','</span>)
        <span style="color: #268bd2;">num_line</span> = []
        <span style="color: #859900;">for</span> element <span style="color: #859900;">in</span> line:
            num_line.append(<span style="color: #859900;">int</span>(element))
        capacity.append(num_line.pop(0))
        priority.append(num_line)
    school_file.close()
    <span style="color: #268bd2;">stud_file</span> = <span style="color: #859900;">open</span>(student,<span style="color: #2aa198;">'r'</span>)
    <span style="color: #268bd2;">preference</span> = []
    <span style="color: #859900;">for</span> line <span style="color: #859900;">in</span> stud_file:
        line.strip()
        <span style="color: #268bd2;">line</span> = line.split(<span style="color: #2aa198;">','</span>)
        <span style="color: #268bd2;">num_line</span>=[]
        <span style="color: #859900;">for</span> element <span style="color: #859900;">in</span> line:
            num_line.append(<span style="color: #859900;">int</span>(element))
        preference.append(num_line)
    stud_file.close()
    <span style="color: #859900;">return</span> priority, capacity, preference


<span style="color: #859900;">def</span> <span style="color: #268bd2;">gen_sc</span>(nschool,nstud,overcap=<span style="color: #2aa198;">False</span>,maxovercap=<span style="color: #2aa198;">False</span>,savefile=<span style="color: #2aa198;">False</span>):
    <span style="color: #2aa198;">"""generates a (pseudo) random school choice problem with nstud students and nschool schools; if overcap ==True, the problem will have a higher number school places than students; maxovercap is a maximum overcapacity allowed; savefile=True will OVERWRITE/save the generated example in the files school.txt and student.txt in the current working directory"""</span>
    <span style="color: #268bd2;">capacity</span> = []
    <span style="color: #268bd2;">average</span> = <span style="color: #859900;">float</span>(nstud)/nschool
    <span style="color: #268bd2;">i</span> = 1
    <span style="color: #859900;">while</span> i&lt;= nschool:
        capacity.append(<span style="color: #859900;">int</span>(random.triangular(average/10.0,3*average,0.2*average)))<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">draws capacity from a triangular distribution between average/5 and 5*average with mode at 0.9*average</span>
        <span style="color: #268bd2;">i</span> = i + 1
        <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">print capacity, i, nschool, sum(capacity)</span>
        <span style="color: #859900;">if</span> i == nschool <span style="color: #859900;">and</span> overcap==<span style="color: #2aa198;">True</span> <span style="color: #859900;">and</span> <span style="color: #859900;">sum</span>(capacity)&lt;nstud:<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">checks that enough places for all students are available</span>
            <span style="color: #268bd2;">capacity</span> = []
            <span style="color: #268bd2;">i</span> = 1
        <span style="color: #859900;">if</span> maxovercap!=<span style="color: #2aa198;">False</span> <span style="color: #859900;">and</span> <span style="color: #859900;">sum</span>(capacity)&gt;nstud + maxovercap:
            <span style="color: #268bd2;">capacity</span> = []
            <span style="color: #268bd2;">i</span> = 1
    <span style="color: #268bd2;">priority</span> = []
    <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nschool):
        <span style="color: #268bd2;">x</span> = <span style="color: #859900;">range</span>(nstud)
        random.shuffle(x)
        priority.append(x)
    <span style="color: #268bd2;">preference</span> = []
    <span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nstud):
        <span style="color: #268bd2;">x</span> = <span style="color: #859900;">range</span>(nschool)
        random.shuffle(x)
        preference.append(x)
    <span style="color: #859900;">if</span> <span style="color: #859900;">sum</span>(capacity)&lt;nstud:<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">creates a dummy school "nschool+1" to which every student not getting a place will be matched</span>
        <span style="color: #859900;">for</span> student <span style="color: #859900;">in</span> preference:
            student.append(nschool)
        priority.append(<span style="color: #859900;">range</span>(nstud))
        capacity.append(nstud)
    <span style="color: #859900;">if</span> savefile!=<span style="color: #2aa198;">False</span>:
        <span style="color: #268bd2;">school_file</span> = <span style="color: #859900;">open</span>(<span style="color: #2aa198;">'school.txt'</span>,<span style="color: #2aa198;">'w'</span>)
        <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nschool):
            <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(capacity[i]) + <span style="color: #2aa198;">','</span>
            <span style="color: #268bd2;">priority_str</span> = <span style="color: #859900;">str</span>(priority[i])
            <span style="color: #268bd2;">priority_str</span> = priority_str.strip(<span style="color: #2aa198;">'['</span>)
            <span style="color: #268bd2;">priority_str</span> = priority_str.strip(<span style="color: #2aa198;">']'</span>)
            <span style="color: #268bd2;">line</span> = line + priority_str 
            school_file.write(line)
            school_file.write(<span style="color: #2aa198;">"\n"</span>)
        school_file.close()
        <span style="color: #268bd2;">stud_file</span> = <span style="color: #859900;">open</span>(<span style="color: #2aa198;">'student.txt'</span>,<span style="color: #2aa198;">'w'</span>)
        <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(nstud):
            <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(preference[i])
            <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">'['</span>)
            <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">']'</span>)
            stud_file.write(line)
            stud_file.write(<span style="color: #2aa198;">"\n"</span>)
        stud_file.close()
    <span style="color: #859900;">return</span> priority, capacity, preference

<span style="color: #859900;">class</span> <span style="color: #b58900;">schoolchoice</span>:
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">__init__</span>(<span style="color: #859900;">self</span>,priority, capacity, preference):
        <span style="color: #2aa198;">"""read in data: priorities is a list of lists where the kth lower level list is the priority of school k, capacity is a list of school capacities (same order of schools as in priority), preferences is a list of lists where the ith sublist is the preference ranking of student i"""</span>
        <span style="color: #859900;">self</span>.priority = priority
        <span style="color: #859900;">self</span>.capacity = capacity
        <span style="color: #859900;">self</span>.preference = preference
        <span style="color: #859900;">self</span>.nschool = <span style="color: #859900;">len</span>(capacity)
        <span style="color: #859900;">if</span> <span style="color: #859900;">self</span>.nschool != <span style="color: #859900;">len</span>(priority):
            <span style="color: #859900;">print</span> <span style="color: #2aa198;">"input error: capacity and priority list must have same length"</span>
        <span style="color: #859900;">self</span>.nstud = <span style="color: #859900;">len</span>(preference)
        <span style="color: #859900;">self</span>.gs_match = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">will contain Gale Shapley match if this is calculated</span>
        <span style="color: #859900;">self</span>.boston_match = []
    <span style="color: #586e75; font-style: italic;">#</span>
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">gs</span>(<span style="color: #859900;">self</span>):
        <span style="color: #2aa198;">"""uses the Gale Shapley student proposing algorithm to solve the matching problem"""</span>
        <span style="color: #268bd2;">flag</span> = 0 <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">dummy used to indicate whether the algorithm has finished</span>
        <span style="color: #268bd2;">pref</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.preference) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
        <span style="color: #859900;">while</span> flag == 0:
            <span style="color: #268bd2;">flag</span> = 1
            <span style="color: #268bd2;">match</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">contains list of lists where the kth lower level list are the students matched with school k</span>
            <span style="color: #268bd2;">unmatched</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of unmatched students</span>
            <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool):
                <span style="color: #268bd2;">proposers</span> = <span style="color: #859900;">filter</span>(<span style="color: #859900;">lambda</span> x: i==pref[x][0],<span style="color: #859900;">self</span>.priority[i])<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">list of students proposing to i in this round</span>
                <span style="color: #859900;">if</span> <span style="color: #859900;">len</span>(proposers)&lt;=<span style="color: #859900;">self</span>.capacity[i]:
                    match.append(proposers)
                <span style="color: #859900;">else</span>:
                    match.append(proposers[:<span style="color: #859900;">self</span>.capacity[i]])
                    <span style="color: #268bd2;">unmatched</span> = unmatched +proposers[<span style="color: #859900;">self</span>.capacity[i]:]
            <span style="color: #859900;">if</span> unmatched != []:
                <span style="color: #268bd2;">flag</span> = 0
                <span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> unmatched:
                    <span style="color: #268bd2;">pref</span>[j]=pref[j][1:]<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">pref[j].pop(0) #deletes the top preference for the unmatched</span>
        <span style="color: #859900;">self</span>.gs_match = <span style="color: #859900;">list</span>(match)
        <span style="color: #859900;">return</span> match
    <span style="color: #586e75; font-style: italic;">#</span>
    <span style="color: #859900;">def</span> <span style="color: #268bd2;">boston</span>(<span style="color: #859900;">self</span>):
        <span style="color: #2aa198;">"""uses the Boston school matching algorithm to solve the matching problem"""</span>
        <span style="color: #268bd2;">flag</span> = 0 <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">dummy used to indicate whether the algorithm has finished</span>
        <span style="color: #268bd2;">pref</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.preference) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
        <span style="color: #268bd2;">capa</span> = <span style="color: #859900;">list</span>(<span style="color: #859900;">self</span>.capacity) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">useful as the algorithm manipulates this list</span>
        <span style="color: #268bd2;">match</span> = [[] <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool)] <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of nschool empty lists, kth list is list of students at school k</span>
        <span style="color: #859900;">while</span> flag == 0:
            <span style="color: #268bd2;">flag</span> = 1
            <span style="color: #268bd2;">unmatched</span> = []<span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">list of unmatched students</span>
            <span style="color: #859900;">for</span> i <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">self</span>.nschool):
                <span style="color: #268bd2;">proposers</span> = <span style="color: #859900;">filter</span>(<span style="color: #859900;">lambda</span> x: i==pref[x][0] <span style="color: #859900;">and</span> x <span style="color: #859900;">not</span> <span style="color: #859900;">in</span> match[i],<span style="color: #859900;">self</span>.priority[i])<span style="color: #586e75; font-style: italic;"># </span><span style="color: #586e75; font-style: italic;">list of students proposing to i in this round</span>
                <span style="color: #859900;">if</span> <span style="color: #859900;">len</span>(proposers)&lt;=capa[i]:
                    <span style="color: #268bd2;">match</span>[i] = match[i] + proposers
                    <span style="color: #268bd2;">capa</span>[i] = capa[i] - <span style="color: #859900;">len</span>(proposers)
                <span style="color: #859900;">else</span>:
                    <span style="color: #268bd2;">match</span>[i] = match[i] + proposers[:capa[i]]
                    <span style="color: #268bd2;">unmatched</span> = unmatched + proposers[capa[i]:]
                    <span style="color: #268bd2;">capa</span>[i] = 0
            <span style="color: #859900;">if</span> unmatched != []:
                <span style="color: #268bd2;">flag</span> = 0
                <span style="color: #859900;">for</span> j <span style="color: #859900;">in</span> unmatched:
                    pref[j].pop(0) <span style="color: #586e75; font-style: italic;">#</span><span style="color: #586e75; font-style: italic;">deletes the top preference for the unmatched</span>
        <span style="color: #859900;">self</span>.boston_match = <span style="color: #859900;">list</span>(match)
        <span style="color: #859900;">return</span> match

<span style="color: #859900;">def</span> <span style="color: #268bd2;">save_scp</span>(scp,filename):
    <span style="color: #2aa198;">"""saves an existing school choice problem with name scp as filename; advantage: will also save previously calculated matches and not only preferences etc."""</span>
    <span style="color: #859900;">with</span> <span style="color: #859900;">open</span>(filename,<span style="color: #2aa198;">'wb'</span>) <span style="color: #859900;">as</span> output:
        pickle.dump(scp,output,pickle.HIGHEST_PROTOCOL)

<span style="color: #859900;">def</span> <span style="color: #268bd2;">open_scp</span>(filename):
    <span style="color: #2aa198;">"""returns a previously as 'filename' saved school choice problem"""</span>
    <span style="color: #859900;">with</span> <span style="color: #859900;">open</span>(filename,<span style="color: #2aa198;">'rb'</span>) <span style="color: #859900;">as</span> <span style="color: #859900;">input</span>:
        <span style="color: #859900;">return</span> pickle.load(<span style="color: #859900;">input</span>)

<span style="color: #859900;">def</span> <span style="color: #268bd2;">save_match</span>(match,filename_school=<span style="color: #2aa198;">'match_school.txt'</span>,filename_student=<span style="color: #2aa198;">'match_student.txt'</span>):
    <span style="color: #2aa198;">"""saves a given match in 2 files: 'match_school' contains in line k the student numbers matched to school k; 'match_student' contains in line k the school matched to student k"""</span>
    <span style="color: #268bd2;">student_lst1</span> = []
    <span style="color: #268bd2;">school_lst</span> = <span style="color: #859900;">open</span>(filename_school,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> school <span style="color: #859900;">in</span> <span style="color: #859900;">range</span>(<span style="color: #859900;">len</span>(match)):
        <span style="color: #859900;">for</span> student <span style="color: #859900;">in</span> match[school]:
            student_lst1.append((student,school))
        <span style="color: #268bd2;">line</span> = <span style="color: #859900;">str</span>(match[school])
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">'['</span>)
        <span style="color: #268bd2;">line</span> = line.strip(<span style="color: #2aa198;">']'</span>)
        school_lst.write(line)
        school_lst.write(<span style="color: #2aa198;">'\n'</span>)
    <span style="color: #268bd2;">student_lst1</span> = <span style="color: #859900;">sorted</span>(student_lst1)
    <span style="color: #268bd2;">student_lst</span> = <span style="color: #859900;">open</span>(filename_student,<span style="color: #2aa198;">'w'</span>)
    <span style="color: #859900;">for</span> item <span style="color: #859900;">in</span> student_lst1:
        student_lst.write(<span style="color: #859900;">str</span>(item[1]))
        student_lst.write(<span style="color: #2aa198;">'\n'</span>)
    student_lst.close()
    school_lst.close()
</pre>
</div>

<p>
The following example generates a random problem with 15 students and 3 schools in which the total capacity is (i) at least 15 and (ii) no higher than 15+5=20. The data is not saved in files. This data is used to initialize a school choice problem called 'ex'. The Gale-Shapley matching is printed and then saved. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #268bd2;">priority</span>,<span style="color: #268bd2;">capacity</span>,<span style="color: #268bd2;">preference</span> = gen_sc(3,15,<span style="color: #2aa198;">True</span>,5,<span style="color: #2aa198;">False</span>)
<span style="color: #268bd2;">ex</span> = schoolchoice(priority,capacity,preference)
<span style="color: #859900;">print</span> ex.gs()
save_match(ex.gs_match)
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; [[8, 3, 12, 0, 6, 11], [1, 4, 10, 7, 9, 5, 14], [13, 2]]
</pre>

<p>
The following example generates a similar example as above but this time the example is saved in the files 'school.txt' and 'student.txt'. These are then read and a school choice problem 'ex' is generated. The Gale-Shapley algorithm is run and the matching is saved using the default file names. Then the school choice problem itself is saved to a file called 'example1'. 'ex' is then deleted. Then the saved school choice problem (formerly called 'ex') is opened and saved as 'ex2'. This contains the result from the Gale Shapley algorithm we ran earlier and to illustrate this we print this result.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">print</span> gen_sc(3,15,<span style="color: #2aa198;">True</span>,5,<span style="color: #2aa198;">True</span>)
<span style="color: #268bd2;">priority</span>,<span style="color: #268bd2;">capacity</span>,<span style="color: #268bd2;">preference</span> = read_sc(<span style="color: #2aa198;">'school.txt'</span>,<span style="color: #2aa198;">'student.txt'</span>)
<span style="color: #268bd2;">ex</span> = schoolchoice(priority,capacity,preference)
save_match(ex.gs())
save_scp(ex,<span style="color: #2aa198;">'example1'</span>)
<span style="color: #859900;">del</span> ex
<span style="color: #268bd2;">ex2</span> = open_scp(<span style="color: #2aa198;">'example1'</span>)
<span style="color: #859900;">print</span> ex2.gs_match
</pre>
</div>

<pre class="example">
([[2, 5, 14, 13, 3, 1, 8, 11, 9, 0, 12, 4, 7, 10, 6], [11, 0, 8, 13, 3, 1, 4, 2, 10, 9, 7, 5, 12, 6, 14], [2, 10, 14, 7, 5, 11, 9, 6, 13, 12, 4, 1, 8, 3, 0]], [12, 4, 1], [[1, 2, 0], [2, 0, 1], [1, 2, 0], [0, 2, 1], [2, 1, 0], [1, 0, 2], [1, 0, 2], [0, 2, 1], [1, 0, 2], [1, 0, 2], [1, 0, 2], [0, 1, 2], [0, 1, 2], [1, 2, 0], [0, 2, 1]])
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; [[5, 14, 3, 1, 11, 9, 12, 7, 10, 6], [0, 8, 13, 2], [4]]
</pre>

<p>
The final example shows that the algorithm works quite fast even for big examples. We create an example with 20.000 students and 150 schools (this is approximately the number of new students in a city of the size of Stockholm) and see how long it takes the PC to solve the Gale Shapley algorithm.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #859900;">import</span> time
<span style="color: #268bd2;">start</span> = time.clock()
<span style="color: #268bd2;">priority</span>, <span style="color: #268bd2;">capacity</span>, <span style="color: #268bd2;">preference</span> = gen_sc(150,20000,<span style="color: #2aa198;">True</span>,1000,<span style="color: #2aa198;">True</span>)
<span style="color: #268bd2;">ex</span> = schoolchoice(priority, capacity, preference)

<span style="color: #268bd2;">mid</span> = time.clock()
<span style="color: #268bd2;">gsmatch</span> = ex.gs()
<span style="color: #268bd2;">end</span> = time.clock()
save_match(gsmatch)
<span style="color: #268bd2;">last</span> = time.clock()

<span style="color: #859900;">print</span> mid-start,<span style="color: #2aa198;">'seconds to generate example; '</span>, end-mid,<span style="color: #2aa198;">'seconds to solve Gale-Shapley algorithm; '</span>, last-end, <span style="color: #2aa198;">'seconds to save matching'</span>
</pre>
</div>

<pre class="example">
&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; 3.260502 seconds to generate example;  42.917447 seconds to solve Gale-Shapley algorithm;  0.048956 seconds to save matching
</pre>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
Gale, David, and Lloyd S. Shapley. "College admissions and the stability of marriage." American Mathematical Monthly (1962): 9-15.
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
 <p>author: Christoph Schottmueller <br> license: Creative Commons Attribution ShareAlike 4.0</p>
</div>
</body>
</html>
